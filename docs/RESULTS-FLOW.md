# Диагностика выдачи результатов: опрос ↔ результаты

Чтобы счётчики и данные на последнем шаге опроса совпадали со страницей результатов, ниже зафиксирована цепочка данных и внесённые правки.

---

## 1. Цепочка данных

### Опрос (QuizWizard)
- Пользователь вводит: возраст, пол, локализация (slug: pechen | grudi | legkie | kishechnik | obshiy), стадия, география (город).
- При «Получить результаты» в API уходит payload: `age, gender, localization, stage, geography, ...`.

### API `POST /api/quiz`
- `server/api/quiz.post.ts`: `mockAnalyze(body)` по `body.localization` и симптомам определяет:
  - `primaryRisk`: `{ slug, label }` (например legkie → `{ slug: 'legkie', label: 'Лёгкие' }`).
  - `methods`: список методов по направлению (из констант).
  - `clinics`: `getClinicsForSlug(primaryRisk.slug, body.geography)`.
- Ответ возвращает: `id, risks, recommendations, methods, clinics, primaryRisk, geography, age, gender, localization, stage, plan, diagnosisStatus`.

### Сохранение результата
- В `QuizWizard` ответ сохраняется в store: `patientStore.addResult(resultSummary)`.
- В `resultSummary` попадают все поля из ответа API (в т.ч. `primaryRisk`, `localization`, `stage`, `geography`, `age`, `gender`).

### Страница результатов `results/[id]`
- Берёт результат из store по `id`.
- **Профиль (ProfileSummary):** возраст, пол, направление, стадия, город — из `result` (в т.ч. `primaryRisk.label` → «Направление», `result.stage` → «Стадия»).
- **Методы:** не из `result.methods`, а из `/api/articles`, отфильтрованные по `result.primaryRisk.slug` (те же ключевые слова, что в опросе), до 6 штук — `breakthroughMethods`.
- **Клиники:** объединение `result.clinics` и клиник по `clinicId` из статей (`clinicsFromMethods`). «В вашем регионе» = фильтр по `result.geography`.

---

## 2. Что сделано для совпадения опроса и результатов

### 2.1 Направление (локализация)
- **Проблема:** для «Лёгкие» (legkie) в API не было ветки, в ответе был `primaryRisk = obshiy` → на результатах отображалось «Общий».
- **Сделано:** в `quiz.post.ts` добавлена ветка `hasLungs` (localization === 'legkie'), возвращается `primaryRisk: { slug: 'legkie', label: 'Лёгкие' }`, рекомендации и методы для лёгких.

### 2.2 Стадия в профиле
- **Проблема:** стадия в ответе API сохранялась, но в блоке профиля на результатах не выводилась.
- **Сделано:** в `ProfileSummary` добавлены проп `stage` и строка «Стадия: …»; в `results/[id]` в `profile` передаётся `result.stage`.

### 2.3 Русские подписи на шаге «Проверьте данные»
- **Проблема:** в блоке проверки выводился slug (например legkie), а не подпись.
- **Сделано:** в `QuizWizard` для «Тип / локализация» выводится `localizationLabel` (по опциям, например «Лёгкие»).

### 2.4 Счётчик «Подходящие методы» в опросе
- **Проблема:** применялся коэффициент по числу шагов → показывалось, например, 4 вместо 6.
- **Сделано:** счётчик в опросе считается так же, как на результатах: фильтр статей по направлению (effectiveLocalization), **без коэффициента**, максимум **6** — `displayMethodsCount = min(6, baseMethodsCountForDisplay)`.

### 2.5 Счётчик «Клиники» в опросе
- **Проблема:** для legkie подставлялся slug `obshiy` → считались другие клиники (например 2 по городу), на результатах — 5 (fallback по legkie).
- **Сделано:** в опросе для счётчика используется тот же slug, что и в quiz: `effectiveSlugForClinics = effectiveLocalization` (без приведения legkie к obshiy). Запрос к `/api/clinics?slug=...&city=...` повторяет логику `getClinicsForSlug`.
- **Дополнительно:** убран коэффициент по шагам — показывается фактическое число клиник из того же запроса.

### 2.6 Одинаковая логика клиник: API и quiz
- **Проблема:** в `clinics.get.ts` для slug `obshiy`/`kishechnik` использовался фильтр по тегу (много клиник), в quiz — `list.slice(0, 8)` без фильтра.
- **Сделано:** в `server/api/clinics.get.ts` для `obshiy` и `kishechnik` возвращается `clinics.slice(0, 8)` без фильтра по тегу; для остальных slug — фильтр по тегу и при пустом результате fallback `slice(0, 5)`, как в `getClinicsForSlug`.

### 2.7 Обновление счётчиков только после перехода
- Счётчики в опросе считаются по «зафиксированным» данным: `effectiveLocalization` и `effectiveGeography` зависят от `committedStep` (обновляется только по «Далее»/«Назад»), чтобы цифры не менялись при выборе варианта, а только после перехода на следующий шаг.

---

## 3. Итог

- **Направление:** в API и на результатах для legkie выводится «Лёгкие».
- **Стадия:** выводится в профиле на результатах.
- **Подпись локализации:** на шаге проверки — по-русски (например «Лёгкие»).
- **Счётчики методов и клиник в опросе:** без коэффициента, методы — до 6, клиники — по тому же slug и городу, что и в quiz; логика `/api/clinics` совпадает с `getClinicsForSlug`.

После этих изменений данные и счётчики на последнем шаге опроса и на странице результатов согласованы.
